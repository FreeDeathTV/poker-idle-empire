**ADR-1401: Optimized Card Selector for Texas Hold'em Bonus**

**Status:** Approved for Implementation  
**Date:** 2026-02-28  
**Owner:** Daniel  
**Scope:** UI-only — Texas Hold'em Bonus modal card picker redesign  
**Non-Scope:** No game logic, no economy changes, no new mechanics, no payout modifications  

---

## **1. Context**

### Current Problem

The existing Texas Hold'em Bonus card selector (lines 304–321, BonusModal.svelte) uses a 13-column grid (`grid-cols-13`) displaying all 52 cards in a single scrollable list:

```svelte
<div class="grid grid-cols-13 gap-1 mt-2 max-h-32 overflow-y-auto">
  {#each deck as card}
```

**User feedback identified:**
- Mobile players must scroll far down the screen to access cards at the end of the list
- Selection requires scrolling + multiple taps to locate specific suits/ranks
- No visual organization by suit — makes quick selection cognitively difficult
- Violates phone-first UX principles (large touch targets, minimal scrolling)

### Desired Outcome

Replace the monolithic deck grid with a compact, hierarchical selector:

1. **Suit tier** — 4 buttons (♠ ♥ ♦ ♣)
2. **Rank tier** — 13 buttons (A, K, Q, J, T, 9–2) visible only when a suit is selected
3. **Greying logic** — First selected card disabled during second card selection
4. **No scrolling** — Both tiers fit within modal bounds

**Impact:** Selection time reduced from ~3 taps + scroll to ~2 taps (1 suit + 1 rank per card).

---

## **2. Scope (Hard Boundary)**

### This ADR Covers ONLY:

- The card picker UI component structure
- Suit button layout and interaction
- Rank button rendering and filtering
- Disabled state for first-selected card during second pick
- Local component state management for `activeSuit`
- Visual feedback (greying, highlighting, transitions)
- Event dispatch using existing `toggleCardSelection()` function

### This ADR Explicitly Does NOT Cover:

- Card selection logic in `gameLogic.ts` (frozen)
- `toggleCardSelection()` function (frozen)
- `$selectedHole` store structure (frozen)
- Card internal representation (`'As'`, `'Kh'`, etc.) (frozen)
- Payout calculation formula (frozen)
- Multiplier table (frozen)
- Starting hand evaluation (frozen)
- Betting mechanics (frozen)
- Poker engine integration (frozen)
- Any new building or progression system
- Any new currency or reward type
- Any new game mechanic

**Hard rule:** If it changes how cards are stored, selected, evaluated, or paid out, it is OUT OF SCOPE.

---

## **3. Core Principle**

The new card selector is a **pure UI transformation** of the existing picker.

**It must:**
- Accept the same store values as input (`$selectedHole`, `deck`)
- Call the same game logic function as output (`toggleCardSelection(card)`)
- Produce identical card strings in identical format (`'As'`, `'Kh'`, etc.)
- Never modify game state
- Never introduce new state persistence
- Never depend on any building, upgrade, or progression system

**It is read-only relative to game logic and state.**

---

## **4. Decision**

We will replace the `grid-cols-13` deck picker with a **two-tier hierarchical selector**:

### **Tier 1: Suit Picker**

```
[ ♠ Spades ] [ ♥ Hearts ] [ ♦ Diamonds ] [ ♣ Clubs ]
```

- 4 equal-width buttons
- Tap to toggle active suit
- Visual highlight when active (border + background color change)
- Always visible

### **Tier 2: Rank Picker (Conditional)**

```
A  K  Q  J  T  9  8  7  6  5  4  3  2
```

- 13 buttons in a single row (grid-cols-13 for ranks only, not all 52 cards)
- Rendered only when a suit is selected
- Disable (grey + cursor-not-allowed) the exact card matching first selection
- All 13 ranks always visible — no scrolling required

### **Selection Logic**

**First card:**
```ts
if (!$selectedHole[0]) {
  call toggleCardSelection(rank + suitCode)
}
```

**Second card:**
```ts
if ($selectedHole[0] && !$selectedHole[1]) {
  const cardCode = rank + suitCode
  if (cardCode !== $selectedHole[0]) {
    call toggleCardSelection(cardCode)
  }
}
```

**Disable rule:**
```ts
disabled = ($selectedHole[0] === rank + suitCode)
```

---

## **5. Behavioural Contract**

### 5.1 Determinism

The selector output must produce identical card strings to the old picker:
- Format: rank + suit code → `'As'`, `'Kh'`, `'Qd'`, `'Cjc'`, etc.
- No transformation or normalization
- No caching or memoization
- Every click produces the same result given the same suit/rank inputs

### 5.2 Read-Only

The selector must not:
- Create new stores
- Modify existing stores
- Call any game logic function except `toggleCardSelection()`
- Depend on any building state
- Depend on any upgrade state
- Depend on any currency state
- Depend on any multiplier state

### 5.3 State Management

Component-local state only:
- `activeSuit`: tracks which suit tab is open
- Reset to `null` when both cards are selected
- No persistence across modal close/reopen
- No connection to localStorage, game state, or stores

### 5.4 Independence from Game Systems

The selector must work:
- Even if no buildings exist
- Even if no upgrades exist
- Even if multipliers change
- Even if the bet amount changes
- Even if offline behavior changes

It depends **only** on:
- The card array structure (52 cards, 4 suits × 13 ranks)
- The `toggleCardSelection()` function
- The `$selectedHole` store (read-only)

---

## **6. Technical Specification**

### Component Structure

**File:** `src/lib/components/CardSelectorOptimized.svelte`

**Props:** None (uses `$selectedHole` store directly)

**Local State:**
```ts
let activeSuit: 'spades' | 'hearts' | 'diamonds' | 'clubs' | null = null;
```

**Constants:**
```ts
const suits = [
  { code: 's', symbol: '♠', label: 'spades' },
  { code: 'h', symbol: '♥', label: 'hearts' },
  { code: 'd', symbol: '♦', label: 'diamonds' },
  { code: 'c', symbol: '♣', label: 'clubs' }
];

const ranks = ['A', 'K', 'Q', 'J', 'T', '9', '8', '7', '6', '5', '4', '3', '2'];
```

**Functions:**

```ts
function isDisabled(rank: string, suitCode: string): boolean {
  if ($selectedHole.length < 1) return false;
  const firstCard = $selectedHole[0];
  return firstCard === rank + suitCode;
}

function handleRankClick(rank: string, suitCode: string) {
  toggleCardSelection(rank + suitCode);
}

function resetSuitPicker() {
  if ($selectedHole.length === 2) {
    activeSuit = null;
  }
}
```

**Reactive:**
```ts
$: if ($selectedHole.length === 2) resetSuitPicker();
```

### Integration Point

**Current location:** `BonusModal.svelte` lines 304–321

**Old code:**
```svelte
<details class="mt-4">
  <summary class="text-gray-400 text-sm cursor-pointer text-center hover:text-white">
    Or pick cards from deck ▼
  </summary>
  <div class="grid grid-cols-13 gap-1 mt-2 max-h-32 overflow-y-auto">
    {#each deck as card}
      <!-- 52 card buttons -->
    {/each}
  </div>
</details>
```

**New code:**
```svelte
<div class="mt-4">
  <div class="text-gray-400 text-sm mb-2">Pick cards from deck</div>
  <CardSelectorOptimized />
</div>
```

**Import:**
```ts
import CardSelectorOptimized from './CardSelectorOptimized.svelte';
```

### Styling

- Suit buttons: flex layout, equal width, border transitions
- Rank buttons: grid-cols-13, same sizing as old picker
- Disabled state: opacity-40, cursor-not-allowed, grey background
- Selected state: yellow background, bold text
- Transitions: smooth all (100–150ms)

---

## **7. Explicit Non-Goals (Foolproofing)**

The card selector implementation must NOT:

- Add any new building
- Add any new upgrade
- Add any new multiplier
- Add any new bonus mechanic
- Add any new streak system
- Add any new progress tracker
- Introduce "suggested hands" AI
- Cache or persist picker state
- Store selection history
- Track picker usage metrics
- Create new stores
- Modify `gameLogic.ts` logic
- Modify `poker.ts` logic
- Modify card string format
- Modify deck generation
- Modify payout calculation
- Modify multiplier table
- Modify betting mechanics
- Create cross-building effects
- Create offline behavior changes
- Create prestige/reset behavior changes

**If a developer attempts to attach a feature like "quick-pick macros" or "AI hand suggestions" to this ADR, that is a violation of scope.**

---

## **8. Acceptance Criteria**

ADR-1401 is complete when:

✅ `CardSelectorOptimized.svelte` component created  
✅ Suit buttons render and toggle `activeSuit` state  
✅ Rank buttons display only when a suit is selected  
✅ First selected card is greyed out during second pick  
✅ All 13 ranks visible without scrolling  
✅ Tapping a rank calls `toggleCardSelection()` with correct card code  
✅ Component resets `activeSuit` when both cards are selected  
✅ Card codes match old picker exactly (`'As'`, `'Kh'`, etc.)  
✅ No new stores created  
✅ No `gameLogic.ts` modifications  
✅ No `poker.ts` modifications  
✅ Integration into `BonusModal.svelte` complete  
✅ Old `<details>` picker removed  
✅ All card selection paths produce identical outcomes to old picker  
✅ No game logic was altered  
✅ No economy impact  
✅ No drift from existing architecture  

---

## **9. Risk Mitigation**

### Risk: Developer adds "smart suggestions"
**Mitigation:** ADR explicitly forbids new AI/logic. Code review enforces scope.

### Risk: Card codes don't match old picker
**Mitigation:** Format verified in tests: `rank[0] + suitCode[0]` must equal old picker output.

### Risk: Disabled state doesn't work correctly
**Mitigation:** Test both selection orders (♠A then ♥K, and vice versa).

### Risk: State persists across modal reopen
**Mitigation:** Component state is scoped locally; modal destruction resets it.

### Risk: Scrolling still required
**Mitigation:** All 13 ranks fit in single row; measure on target devices (mobile 320px–480px).

---

## **10. Final Lock**

**ADR-1401 is a UI-only specification.**

It must never be interpreted as a gameplay feature.  
It must never introduce or modify any game logic.  
It must never reference buildings, upgrades, multipliers, or progression.  
It must never create new state persistence.  
It must never alter payout calculation.  

**Any change that violates this scope requires a new ADR (ADR-1402+).**

---

## **11. Drift Prevention Enforcement**

**For all future PRs touching card selection:**

1. **PR must reference ADR-1401**
2. **PR description must explicitly state what is NOT changed:**
   - Game logic: ✓ unchanged
   - Store structure: ✓ unchanged
   - Payout formula: ✓ unchanged
   - Multiplier table: ✓ unchanged
   - Betting mechanics: ✓ unchanged
3. **Code review checklist:**
   - [ ] No modifications to `gameLogic.ts` selection logic
   - [ ] No new stores created
   - [ ] No calls to game functions except `toggleCardSelection()`
   - [ ] Card codes match `'As'` format
   - [ ] Component state is local only
   - [ ] First card greying works in both selection orders

**Violation → PR rejected with reference to ADR-1401 scope violation.**

---

**Signed:** Drift Safety Expert & Monetization Specialist  
**Date:** 2026-02-28  
**Status:** Ready for Implementation